{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template block_lpprogressx/lpprogressx

    This template renders the learning plan progress. 
    It adds js click action from PlanActions.prototype._showLinkedCoursesHandler from tool_lp/planactions 
    to show linked courses.


    Example context (json):
    {
        "plans": [{
            "name": "A learning plan example",
                "iscompleted": 1,
                "competencies": [{
                    "isproficient": 1,
                    "competency": {
                        "id": 1,
                        "shortname": "Competency number one"
                    }
                },
                {
                  "isproficient": 1,
                    "competency": {
                        "id": 1,
                        "shortname": "Competency number two"
                    }
                }]
        }]
    }
}}
<div class="singlebutton">
    <form method="get" action="{{url}}">
        <input type="hidden" name="userid" value="{{usrid}}">
        <button type="submit" class="btn btn-secondary" id="single_button625ee1973d6e019" title="">{{#str}} addnewplan, tool_lp {{/str}}</button>
    </form>
    <br>
</div>

<div class="metatile-container">
  {{^plans}}
    <p dir="ltr" style="text-align: left;"><span>Lass dir vorbereitete Lernpläne anzeigen. Diese Option kannst du aktivieren, indem du in deinem Profil unter&nbsp;</span><a href="https://dev-isy.th-luebeck.de/oncapflege/user/edit.php?returnto=profile">Profil bearbeiten</a>&nbsp;bei&nbsp;<strong>Weitere Felder</strong>&nbsp;das Feld&nbsp;<strong>Lernplanvorschläge</strong><span>&nbsp;anzeigen ankreuzt. Das System sucht dann vorbereitete Lernpläne aus und zeigt sie dir an. Du kannst selbst entscheiden, ob du den gesamten Lernpfad oder nur Teile davon absolvieren möchtest.</span></p>  
  {{/plans}}
  {{#plans}}
  {{#insidebar}}
    <div class="metatile">
  {{/insidebar}}
  {{^insidebar}}     
    <div class="metatile">
  {{/insidebar}}
        <div class="metatile-img d-flex justify-content-center align-items-center">
        {{#iscompleted}}
            <i class="fa fa-3x fa-graduation-cap green"></i>
        {{/iscompleted}}
        {{^iscompleted}} 
            <i class="fa fa-3x fa-sitemap text-primary"></i>
        {{/iscompleted}}
        </div>
        <div class="metatile-content">
            <h2 class="d-flex justify-content-between align-items-center">
                <a class="sectiontoggle collapsed {{#iscompleted}} green {{/iscompleted}}" data-toggle="collapse" href="#collapsePlan{{id}}" role="button" aria-expanded="false" aria-controls="collapsePlan{{id}}">
                    {{name}}
                </a>
                <a class="sectiontoggle collapsed {{#iscompleted}} green {{/iscompleted}}" data-toggle="collapse" href="#collapsePlan{{id}}" role="button" aria-expanded="false" aria-controls="collapsePlan{{id}}">
                    ▾▴
                </a>
                <a href="{{url}}" class="ml-auto hidden">
                    <i class="icon fa fa-cog fa-fw " title="Lernplan individualisieren" role="img" aria-label="Lernplan individualisieren"></i>
                </a>
                    
            </h2>
            <div class="col-md-12 collapse" id="collapsePlan{{id}}" >
              <ul id="progressbar">
                {{#competencies}}
                  <li class="step0 {{#isproficient}}active green{{/isproficient}} ">
                    <a class="{{#isproficient}}active green{{/isproficient}}" href="#" data-id="{{competency.id}}" data-action="find-courses-link">{{competency.shortname}}</a>
                    <a data-toggle="collapse" href="#competencyDescription{{competency.id}}" role="button" aria-expanded="false" aria-controls="competencyDescription{{competency.id}}">…</a>
                    <div class="collapse" id="competencyDescription{{competency.id}}">
                        {{{competency.description}}}
                    </div>
                  </li>
                {{/competencies}}
                <li class="step0 {{#iscompleted}}active{{/iscompleted}}">
                  <h4 class="{{^iscompleted}}text-muted{{/iscompleted}}{{#iscompleted}}green{{/iscompleted}} final">{{#str}} completed, block_lpprogressx {{/str}}</h4>
                </li>
              </ul>

            </div>
        </div>
    </div>
  {{/plans}}
</div>
{{#js}}
require(['jquery',
        'core/templates',
        'core/ajax',
        'core/notification',
        'core/str',
        'tool_lp/dialogue'],
        function($, templates, ajax, notification, str, Dialogue) {

    $('section.block_lpprogressx').find('[data-action="find-courses-link"]').click(function(e) {
        e.preventDefault();

        var competencyid = $(e.target).data('id');
        var requests = ajax.call([{
            methodname: 'tool_lp_list_courses_using_competency',
            args: {id: competencyid}
        }]);

        requests[0].done(function(courses) {
            courses.forEach(function (course) {
                // tinjohn ADDED Extract the first part of the shortname until "_"
                var shortnamePrefix = course.shortname.split('_')[0];
                // Check if it contains 'AT' and set 'AT' attribute accordingly
                course.AT = shortnamePrefix.includes('AT');
            });
            courses.sort(function (a, b) {
                // Example: Sorting alphabetically based on course names
                return a.shortname.localeCompare(b.shortname);
            });
          
            var context = {
                courses: courses
            };
            templates.render('tool_lp/linked_courses_summary', context).done(function(html) {
                str.get_string('linkedcourses', 'block_lpprogressx').done(function(linkedcourses) {
                    new Dialogue(
                        linkedcourses, // Title.
                        html // The linked courses.
                    );
                }).fail(notification.exception);
            }).fail(notification.exception);
        }).fail(notification.exception);
    });
});
{{/js}}
